const DEFAULT_LANG="zh-TW",SUPPORTED_LANG={en:{err:"Error",pepw:"Please enter password.",pwcnbe:"Password is empty!",enpw:"Enter a new password (Keeping it empty will remove the current password)",pwss:"Password set successfully.",pwrs:"Password removed successfully.",cpys:"Copied!"},zh:{err:"出错了",pepw:"请输入密码",pwcnbe:"密码不能为空！",enpw:"输入新密码（留空可清除当前密码）",pwss:"密码设置成功！",pwrs:"密码清除成功！",cpys:"已复制"},"zh-TW":{err:"出錯了",pepw:"請輸入密碼",pwcnbe:"密碼不能為空！",enpw:"輸入新密碼（留空可清除當前密碼）",pwss:"密碼設置成功！",pwrs:"密碼清除成功！",cpys:"已複製"}},getI18n=e=>{const n=(navigator.language||navigator.userLanguage||"zh-TW").split("-")[0],t=Object.keys(SUPPORTED_LANG).find(e=>e===n)||"zh-TW";return SUPPORTED_LANG[t][e]},errHandle=e=>{alert(`${getI18n("err")}: ${e}`)},throttle=(e,n)=>{let t=null;return(...r)=>{t||(t=setTimeout(()=>{e(...r),t=null},n))}},passwdPrompt=()=>{const e=window.prompt(getI18n("pepw"));if(null==e)return;e.trim()||alert(getI18n("pwcnbe"));const n=location.pathname;window.fetch(`${n}/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({passwd:e})}).then(e=>e.json()).then(e=>{if(0!==e.err)return errHandle(e.msg);e.data.refresh&&window.location.reload()}).catch(e=>errHandle(e))},renderPlain=(e,n)=>{e&&(e.innerHTML=DOMPurify.sanitize(n))},renderMarkdown=(e,n)=>{if(e){const t=marked.parse(n);e.innerHTML=DOMPurify.sanitize(t)}};window.addEventListener("DOMContentLoaded",function(){const e=document.querySelector("#contents"),n=document.querySelector("#loading"),t=document.querySelector(".opt-pw"),r=document.querySelector(".opt-mode > input"),o=document.querySelector(".opt-share > input"),a=document.querySelector("#preview-plain"),i=document.querySelector("#preview-md"),l=document.querySelector(".share-modal"),s=document.querySelector(".share-modal .close-btn"),d=document.querySelector(".share-modal .opt-button"),c=document.querySelector(".share-modal input");renderPlain(a,e.value),renderMarkdown(i,e.value),e&&(window.ENABLE_R2&&e.addEventListener("paste",function(n){const t=(n.clipboardData||n.originalEvent.clipboardData).items;for(let r in t){const o=t[r];if("file"===o.kind&&o.type.startsWith("image/")){n.preventDefault();const t=o.getAsFile(),r=e.selectionStart,a="![Uploading...]()";e.value=e.value.substring(0,r)+a+e.value.substring(e.selectionEnd),e.selectionStart=e.selectionEnd=r+a.length;const l=new FormData;return l.append("image",t),void window.fetch("/upload",{method:"POST",body:l}).then(e=>e.json()).then(n=>{if(0===n.err){const t=`![image](${n.data})`;e.value=e.value.replace(a,t),renderMarkdown(i,e.value)}else e.value=e.value.replace(a,`[Upload Failed: ${n.msg}]`),alert(`Upload Failed: ${n.msg}`)}).catch(n=>{e.value=e.value.replace(a,"[Upload Failed]"),alert(`Upload Error: ${n}`)})}}}),e.oninput=throttle(function(){renderMarkdown(i,e.value),n.style.display="inline-block";const t={t:e.value};window.fetch("",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t)}).then(e=>e.json()).then(e=>{0!==e.err&&errHandle(e.msg)}).catch(e=>errHandle(e)).finally(()=>{n.style.display="none"})},1e3)),t&&(t.onclick=function(){const e=window.prompt(getI18n("enpw"));if(null==e)return;const n=window.location.pathname;window.fetch(`${n}/pw`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({passwd:e.trim()})}).then(e=>e.json()).then(n=>{if(0!==n.err)return errHandle(n.msg);alert(getI18n(e?"pwss":"pwrs"))}).catch(e=>errHandle(e))}),r&&(r.onclick=function(e){const n=e.target.checked,t=window.location.pathname;window.fetch(`${t}/setting`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:n?"md":"plain"})}).then(e=>e.json()).then(e=>{if(0!==e.err)return errHandle(e.msg);window.location.reload()}).catch(e=>errHandle(e))}),o&&(o.onclick=function(e){const n=e.target.checked,t=window.location.pathname;window.fetch(`${t}/setting`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({share:n})}).then(e=>e.json()).then(e=>{if(0!==e.err)return errHandle(e.msg);if(n){const n=`${window.location.origin}/share/${e.data}`;c.value=n,l.style.display="block"}}).catch(e=>errHandle(e))}),l&&(s.onclick=function(){l.style.display="none"},d.onclick=function(){clipboardCopy(c.value);const e=d.innerHTML,n=d.style.background;d.innerHTML=getI18n("cpys"),d.style.background="orange",window.setTimeout(()=>{l.style.display="none",d.innerHTML=e,d.style.background=n},1500)})});