# LLM / Developer Notes üß†

This document serves as a guide for future LLMs (and human developers) working on `cf-notepad`. It highlights specific architectural decisions, pitfalls, and "gotchas" encountered during development.

## 1. Template Literals & Escaping (CRITICAL) ‚ö†Ô∏è
The project uses `src/template.js` to generate the HTML string for the Cloudflare Worker response.
- **Problem**: This means `src/template.js` contains a large Template Literal.
- **The Pitfall**: When writing **client-side JavaScript** code inside this template (e.g., inside `<script>` tags), you MUST handle backticks (\`) and variable interpolation (`${}`) carefully.
- **Solution**:
    - Escape backticks in client-side code: use `\` (regex `new RegExp(...)` is often safer/clearer than `\/`).
    - **CRITICAL**: Escape template literal interpolation in client-side code (`\${variable}`) to prevent the server-side JS engine from trying to evaluate it.
    - **Example**:
      ```javascript
      // WRONG (Server tries to evaluate Date.now() and i)
      const id = `mermaid-svg-${Date.now()}-${i}`;
      
      // CORRECT (Client-side evaluation)
      const id = \`mermaid-svg-\${Date.now()}-\${i}\`;
      ```

## 2. Mermaid & Diagram Rendering üìä
We use a **Smart Lazy Loading** approach. Libraries are only loaded if specific code blocks are detected.

### Mermaid Implementation
- **Rendering**: Do NOT use `mermaid.run()`. It caused issues with the dynamically injected content.
- **Current Approach**: We manually assume control using `mermaid.render(id, code)`.
- **HTML Entities**: The content retrieved from the hidden `textarea` or `div` will have HTML entities (e.g., `&gt;` instead of `>`).
    - **Fix**: You MUST decode these entities before passing code to `mermaid.render`.
    - `code.replace(/&lt;/g, '<').replace(/&gt;/g, '>')`
- **Error Handling**: Wrap render calls in `try/catch` and display a friendly error message in the DOM if parsing fails.

### Other Diagrams
- **Flowchart.js, Graphviz, Sequence**: Similar lazy-loading pattern. Ensure containers have unique IDs if the library requires it.

## 3. DOMPurify Configuration üõ°Ô∏è
Advanced Markdown features (Math, Diagrams) require specific HTML/SVG attributes.
- We must relax `DOMPurify` rules to allow:
    - SVG tags (`svg`, `g`, `path`, etc.)
    - Attributes like `style`, `class`, `id`, `viewBox`.
- **Pitfall**: If diagrams render as blank or stripped text, check `DOMPurify` config in `src/template.js`.

## 4. Scroll Sync (Editor <-> Preview) üìú
- **Problem**: Naive `scroll` event listeners cause infinite loops (Left scrolls Right -> Right scrolls Left -> ...).
- **Failed Attempt**: Using `mouseenter` to detect which side is active failed (touch devices, fast movement).
- **Solution**: Use **Mutex Flags** (`isSyncingLeft`, `isSyncingRight`) with a small `setTimeout` debounce.
    - When Left scrolls: set `isSyncingRight = true`, scroll Right.
    - Right's scroll event checks `isSyncingRight`; if true, ignores logic.

## 5. Mobile Layout (100dvh) üì±
- **Problem**: Mobile browser toolbars cover the footer if using `100vh`.
- **Solution**: Use `height: 100dvh` (Dynamic Viewport Height) for `.note-container` and `body`.

## 6. Cloudflare Workers Environment ‚òÅÔ∏è
- **KV Namespace**: Note data is stored in `NOTES`, rendering/view stats in `SHARE`.
- **Wrangler**: Local dev uses `wrangler dev`.
- **Routing**: `itty-router` handles routing. Be careful with route ordering.

---
*Generated by Antigravity (Gemini) - 2026/01/12*
